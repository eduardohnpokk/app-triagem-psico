// --- DENTRO DO dashboard.html (Lógica atualizada) ---

document.getElementById('btnGerarGlobal').onclick = async () => {
    const btn = document.getElementById('btnGerarGlobal');
    btn.disabled = true; btn.innerText = "Sincronizando Dados Clínicos...";

    try {
        const q = query(collection(db, "usuarios", userId, "historico_testes"), orderBy("data", "desc"));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
            alert("Realize protocolos individuais para gerar o dossiê global.");
            return;
        }

        const ultimosResultados = {};
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (!ultimosResultados[data.teste_id]) {
                ultimosResultados[data.teste_id] = data;
            }
        });

        // Cálculo do IBE (Índice de Bem-Estar)
        let totalWeightedScore = 0; let totalPossibleWeight = 0;
        Object.values(ultimosResultados).forEach(res => {
            const tInfo = Battery[res.teste_id];
            if (tInfo) {
                // Inverte a lógica para escalas de transtorno: quanto menor o score, melhor a saúde.
                const scorePercent = (res.score_bruto / tInfo.maxScore);
                const invertedFunctionalScore = (1 - scorePercent) * 100;
                totalWeightedScore += (invertedFunctionalScore * tInfo.weight);
                totalPossibleWeight += tInfo.weight;
            }
        });

        const ibeFinal = Math.round(totalWeightedScore / totalPossibleWeight);
        gerarPDFConsolidado(ultimosResultados, ibeFinal);

    } catch (error) {
        console.error(error);
        alert("Erro no processamento.");
    } finally {
        btn.disabled = false; btn.innerText = "GERAR RELATÓRIO GLOBAL";
    }
};

function gerarPDFConsolidado(dados, ibe) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const dataEmissao = new Date().toLocaleDateString('pt-BR');
    let y = 65;

    // Capa Master
    doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 60, 'F');
    doc.setTextColor(255); doc.setFontSize(24); doc.setFont("helvetica", "bold");
    doc.text("DOSSIÊ NEUROPSICOLÓGICO CONSOLIDADO", 20, 35);
    doc.setFontSize(11); doc.setFont("helvetica", "normal");
    doc.text(`Paciente: ${userName} | Emissão: ${dataEmissao}`, 20, 50);

    // Módulo IBE
    doc.setTextColor(15, 23, 42); doc.setFontSize(16); doc.text("1. ÍNDICE DE BEM-ESTAR GLOBAL (IBE)", 20, 80);
    doc.setFontSize(30); doc.text(`${ibe}%`, 160, 80);
    doc.setDrawColor(200); doc.line(20, 83, 190, 83);
    doc.setFontSize(10); 
    const ibeDesc = "O IBE representa o nível de funcionalidade preservada através dos 13 domínios rastreados. Um índice próximo a 100% indica baixa sintomatologia clínica geral.";
    doc.text(doc.splitTextToSize(ibeDesc, 130), 20, 92);

    // Listagem Cirúrgica
    y = 115;
    doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text("2. SÍNTESE POR DOMÍNIO", 20, y);
    doc.line(20, y+3, 190, y+3);
    y += 12;
    
    Object.values(dados).forEach(teste => {
        if (y > 270) { doc.addPage(); y = 30; }
        doc.setFontSize(11); doc.setFont("helvetica", "bold");
        doc.text(`• ${teste.teste}:`, 20, y);
        doc.setFont("helvetica", "normal");
        doc.text(`${teste.resultado_texto}`, 80, y);
        y += 8;
    });

    // Cruzamento Clínico Final
    y += 15;
    if (y > 240) { doc.addPage(); y = 30; }
    doc.setFontSize(14); doc.setFont("helvetica", "bold");
    doc.text("3. ANÁLISE DE COMORBIDADES E INTERCONEXÕES", 20, y);
    doc.line(20, y+3, 190, y+3);
    y += 12;
    doc.setFontSize(10);
    const conclusao = "A integração destes resultados permite observar a correlação entre sintomas (ex: como o déficit de atenção impacta a ansiedade social). Este documento fornece evidências qualitativas para a construção do diagnóstico diferencial em ambiente clínico especializado.";
    doc.text(doc.splitTextToSize(conclusao, 170), 20, y);

    // Assinatura Técnica
    doc.setFontSize(10); doc.setTextColor(100);
    doc.text("Dr. Eduardo Pokk | Especialista em TI & Psicologia", 65, 285);
    doc.save(`Dossie_Consolidado_${userName.replace(/\s+/g, '_')}.pdf`);
}
