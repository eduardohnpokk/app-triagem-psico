<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreio TDAH Adulto | Dr. Eduardo Pokk</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* ESTILO VISUAL PADRÃO (Azul - TDAH) */
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --text: #334155; --white: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }
        header { background: var(--white); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
        .brand { font-weight: 800; font-size: 1.1rem; color: var(--primary); text-decoration: none; }
        .back-link { font-size: 0.9rem; color: #64748b; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .main-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 20px; }
        .quiz-box { background: var(--white); width: 100%; max-width: 700px; padding: 40px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); text-align: center; border: 1px solid #e2e8f0; }
        .btn-primary { background: var(--accent); color: white; padding: 15px 40px; border-radius: 8px; border: none; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background 0.2s; width: 100%; }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Componentes Quiz */
        .progress-container { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; margin-bottom: 30px; display: none; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; border-radius: 4px; transition: width 0.4s ease; }
        .step-indicator { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: none; }
        .options-grid { display: flex; flex-direction: column; gap: 12px; }
        .option-btn { padding: 18px 20px; border: 2px solid #e2e8f0; background: var(--white); border-radius: 10px; cursor: pointer; font-size: 1rem; color: var(--primary); font-weight: 500; text-align: left; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .option-btn:hover { border-color: var(--accent); background: #eff6ff; color: var(--accent); transform: translateX(5px); }
        footer { text-align: center; padding: 20px; font-size: 0.8rem; color: #94a3b8; border-top: 1px solid #e2e8f0; background: var(--white); }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="brand">Eduardo Pokk <span>PSI</span></a>
        <a href="dashboard.html" class="back-link"><i class="fa-solid fa-chevron-left"></i> Voltar ao Dashboard</a>
    </header>

    <div class="main-container">
        <div id="intro-screen" class="quiz-box fade-in">
            <div style="font-size: 2.5rem; color: var(--accent); margin-bottom: 20px;"><i class="fa-solid fa-brain"></i></div>
            <h1>Rastreio de TDAH em Adultos</h1>
            <p>Protocolo Clínico ASRS-18 (OMS).<br>Gera um Dossiê Técnico em PDF com análise de comorbidades.</p>
            <div style="font-size: 0.85rem; background: #f1f5f9; padding: 10px; border-radius: 6px; color: #64748B; margin-bottom: 20px;">
                <i class="fa-solid fa-user-doctor"></i> Supervisão: Dr. Eduardo Pokk (CRP 06/73583)
            </div>
            
            <button class="btn-primary" onclick="startQuiz()">Iniciar Protocolo</button>
        </div>

        <div id="quiz-screen" class="quiz-box hidden">
            <div class="step-indicator" id="step-text">...</div>
            <div class="progress-container"><div class="progress-fill" id="progress-bar"></div></div>
            <h2 id="question-text">...</h2>
            <div class="options-grid" id="options-container"></div>
        </div>

        <div id="processing-screen" class="quiz-box hidden">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
            <h2>Processando Resultados...</h2>
            <p style="color: #64748b; font-size: 0.9rem;">Salvando dados seguros...</p>
        </div>

        <div id="result-screen" class="quiz-box hidden">
            <div style="font-size: 3rem; color: #16a34a; margin-bottom: 20px;"><i class="fa-solid fa-file-contract"></i></div>
            <h1>Dossiê Gerado</h1>
            <p>Seu relatório técnico foi salvo e está pronto para download.</p>
            <button class="btn-primary" onclick="generatePremiumPDF()">
                <i class="fa-solid fa-download"></i> BAIXAR DOSSIÊ COMPLETO
            </button>
        </div>
    </div>

    <footer>Supervisão Técnica: Eduardo Pokk | Psicólogo CRP 06/73583</footer>

    <script type="module">
        // 1. IMPORTA O BANCO DE DADOS
        import { db } from './firebase-config.js';
        import { doc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. IDENTIFICA O USUÁRIO (Vindo do Cadastro)
        const currentUser = {
            name: localStorage.getItem('usuario_nome') || "Visitante Anônimo",
            id: localStorage.getItem('usuario_id')
        };

        const questions = [
            { text: "Com que frequência você tem dificuldade para finalizar os detalhes finais de um projeto, quando as partes difíceis já foram concluídas?", type: "A", threshold: 2 },
            { text: "Com que frequência você tem dificuldade para organizar as coisas quando precisa fazer algo que exige planejamento?", type: "A", threshold: 2 },
            { text: "Com que frequência você tem problemas para lembrar de compromissos ou obrigações?", type: "A", threshold: 2 },
            { text: "Quando precisa fazer algo que exige muito pensamento, com que frequência você evita ou adia o início?", type: "A", threshold: 3 },
            { text: "Com que frequência você balança as mãos ou os pés quando precisa ficar sentado por muito tempo?", type: "A", threshold: 3 },
            { text: "Com que frequência você se sente excessivamente ativo e compelido a fazer coisas, como se estivesse 'com o motor ligado'?", type: "A", threshold: 3 },
            { text: "Com que frequência você comete erros por descuido quando tem que trabalhar num projeto chato ou difícil?", type: "B", threshold: 2 },
            { text: "Com que frequência você tem dificuldade para manter a atenção quando está fazendo um trabalho chato ou repetitivo?", type: "B", threshold: 2 },
            { text: "Com que frequência você tem dificuldade para se concentrar no que as pessoas dizem, mesmo quando elas falam diretamente com você?", type: "B", threshold: 2 },
            { text: "Com que frequência você perde ou tem dificuldade para encontrar objetos em casa ou no trabalho?", type: "B", threshold: 2 },
            { text: "Com que frequência você se distrai com atividades ou barulhos ao seu redor?", type: "B", threshold: 2 },
            { text: "Com que frequência você se levanta da cadeira em reuniões ou em outras situações onde deveria ficar sentado?", type: "B", threshold: 2 },
            { text: "Com que frequência você se sente inquieto ou agitado?", type: "B", threshold: 2 },
            { text: "Com que frequência você tem dificuldade para sossegar e relaxar quando tem tempo livre?", type: "B", threshold: 2 },
            { text: "Com que frequência você fala demais em situações sociais?", type: "B", threshold: 2 },
            { text: "Quando está numa conversa, com que frequência você termina as frases das pessoas antes delas?", type: "B", threshold: 2 },
            { text: "Com que frequência você tem dificuldade para esperar sua vez em situações onde cada um tem a sua vez?", type: "B", threshold: 2 },
            { text: "Com que frequência você interrompe os outros quando eles estão ocupados?", type: "B", threshold: 2 }
        ];

        const options = [{ label: "Nunca", value: 0 }, { label: "Raramente", value: 1 }, { label: "Algumas vezes", value: 2 }, { label: "Frequentemente", value: 3 }, { label: "Muito Frequentemente", value: 4 }];
        let currentQ = 0, userAnswers = [];

        // Expondo funções para o HTML (Necessário quando se usa type="module")
        window.startQuiz = startQuiz;
        window.generatePremiumPDF = generatePremiumPDF;

        function startQuiz() { 
            document.getElementById('intro-screen').classList.add('hidden'); 
            document.getElementById('quiz-screen').classList.remove('hidden'); 
            document.querySelector('.progress-container').style.display = 'block'; 
            document.querySelector('.step-indicator').style.display = 'block'; 
            renderQuestion(); 
        }

        function renderQuestion() { 
            document.getElementById('question-text').innerText = questions[currentQ].text; 
            document.getElementById('step-text').innerText = `PERGUNTA ${currentQ + 1} DE ${questions.length}`; 
            document.getElementById('progress-bar').style.width = `${((currentQ) / questions.length) * 100}%`; 
            const container = document.getElementById('options-container'); 
            container.innerHTML = ''; 
            options.forEach(opt => { 
                const btn = document.createElement('div'); 
                btn.className = 'option-btn fade-in'; 
                btn.innerHTML = `<div style="width:12px;height:12px;border:2px solid #cbd5e1;border-radius:50%;"></div> ${opt.label}`; 
                btn.onclick = () => handleAnswer(opt.value); 
                container.appendChild(btn); 
            }); 
        }

        function handleAnswer(val) { 
            userAnswers.push(val); 
            if (currentQ < questions.length - 1) { currentQ++; setTimeout(renderQuestion, 200); } 
            else { finishQuiz(); } 
        }

        // 3. FUNÇÃO ALTERADA PARA SALVAR NO BANCO
        async function finishQuiz() { 
            document.getElementById('quiz-screen').classList.add('hidden'); 
            document.getElementById('processing-screen').classList.remove('hidden'); 

            // Calcula pontuação para salvar
            let partAScore = 0;
            userAnswers.forEach((ans, i) => {
                if (i < 6 && ans >= questions[i].threshold) partAScore++;
            });
            const resultadoFinal = partAScore >= 4 ? "POSITIVO TDAH" : "NEGATIVO TDAH";

            // Salva no Firebase (Se tiver usuário logado)
            if (currentUser.id) {
                try {
                    // Cria uma referência ao documento do usuário
                    const userDocRef = doc(db, "usuarios", currentUser.id);
                    // Cria uma coleção 'historico_testes' dentro desse usuário
                    const historicoRef = collection(userDocRef, "historico_testes");
                    
                    await addDoc(historicoRef, {
                        teste: "TDAH (ASRS-18)",
                        data: new Date(),
                        resultado: resultadoFinal,
                        pontuacao_parte_A: partAScore,
                        respostas_brutas: userAnswers
                    });
                    console.log("Resultado salvo com sucesso no Firebase!");
                } catch (error) {
                    console.error("Erro ao salvar no banco:", error);
                }
            } else {
                console.warn("Nenhum usuário logado. Resultado não será salvo no banco.");
            }

            // Mostra tela final após salvar (ou tentar)
            setTimeout(() => { 
                document.getElementById('processing-screen').classList.add('hidden'); 
                document.getElementById('result-screen').classList.remove('hidden'); 
            }, 1000); 
        }

        async function generatePremiumPDF() {
            if (!window.jspdf) { alert("Erro JS PDF"); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pageWidth = 210, pageHeight = 297, margin = 20;
            
            const colPrimary = [15, 23, 42]; 
            const colAccent = [37, 99, 235]; 
            const colBg = [248, 250, 252]; 
            const colGray = [100, 116, 139];

            let partAScore = 0, inattentiveRaw = 0, hyperactiveRaw = 0;
            userAnswers.forEach((ans, i) => {
                if (i < 6 && ans >= questions[i].threshold) partAScore++;
                if ([0,1,2,3,6,7,8,9,10].includes(i)) inattentiveRaw += ans; else hyperactiveRaw += ans;
            });
            const isPositive = partAScore >= 4;

            function drawHeader(p) {
                doc.setFillColor(...colAccent); doc.rect(0, 0, 8, pageHeight, 'F');
                doc.setFont("helvetica", "bold"); doc.setFontSize(12); doc.setTextColor(...colPrimary);
                doc.text("Eduardo Pokk | PSI", margin, 15);
                doc.setFontSize(8); doc.setTextColor(100);
                doc.text("CRP 06/73583", margin, 20);
                
                doc.setFontSize(10); doc.setTextColor(0);
                doc.text(`Paciente: ${currentUser.name}`, margin, 30);

                doc.setFontSize(8); doc.setTextColor(100);
                doc.text(`Emissão: ${new Date().toLocaleDateString()}`, pageWidth-margin-30, 15);
                doc.setDrawColor(200); doc.line(margin, 35, pageWidth-margin, 35);
            }
            function drawFooter(p) {
                doc.setFontSize(8); doc.setTextColor(150);
                doc.text(`Página ${p} - ${currentUser.name}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                doc.text("Este documento não substitui avaliação médica presencial.", margin, pageHeight - 10);
            }

            // PÁGINA 1
            doc.setFillColor(...colBg); doc.rect(0, 0, pageWidth, pageHeight, 'F');
            doc.setFillColor(...colPrimary); doc.circle(pageWidth/2, 100, 25, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(30); doc.text("TDAH", pageWidth/2, 103, { align: 'center' });
            
            doc.setFont("helvetica", "bold"); doc.setFontSize(26); doc.setTextColor(...colPrimary);
            doc.text("DOSSIÊ DE RASTREIO", pageWidth/2, 140, { align: 'center' });
            doc.text("NEUROPSICOLÓGICO", pageWidth/2, 152, { align: 'center' });
            
            doc.setFont("helvetica", "normal"); doc.setFontSize(14); doc.setTextColor(...colAccent);
            doc.text("Protocolo ASRS-18 (OMS)", pageWidth/2, 165, { align: 'center' });
            
            doc.setFontSize(12); doc.setTextColor(50);
            doc.text(`Paciente: ${currentUser.name}`, pageWidth/2, 230, { align: 'center' });

            // PÁGINA 2
            doc.addPage(); drawHeader(2);
            let cy = 50;
            doc.setFont("helvetica", "bold"); doc.setFontSize(16); doc.setTextColor(...colPrimary);
            doc.text("1. ANÁLISE QUANTITATIVA", margin, cy);
            cy += 15;

            if (isPositive) {
                doc.setFillColor(254, 242, 242); doc.setDrawColor(220, 38, 38); doc.setTextColor(185, 28, 28);
                var resultText = "ALTA PROBABILIDADE CLÍNICA";
            } else {
                doc.setFillColor(240, 253, 244); doc.setDrawColor(22, 163, 74); doc.setTextColor(21, 128, 61);
                var resultText = "BAIXA PROBABILIDADE CLÍNICA";
            }
            doc.rect(margin, cy, pageWidth - (margin*2), 25, 'FD');
            doc.setFontSize(14); doc.text(resultText, pageWidth/2, cy + 16, { align: 'center' });

            cy += 40;
            doc.setFont("helvetica", "bold"); doc.setTextColor(...colPrimary); doc.setFontSize(11);
            doc.text("Perfil de Sintomas:", margin, cy);
            
            cy += 10;
            doc.setFont("helvetica", "normal"); doc.text("Desatenção", margin, cy + 5);
            doc.setFillColor(226, 232, 240); doc.rect(60, cy, 100, 8, 'F');
            doc.setFillColor(...colAccent);
            doc.rect(60, cy, (inattentiveRaw / 36) * 100, 8, 'F');

            cy += 15;
            doc.text("Hiperatividade", margin, cy + 5);
            doc.setFillColor(226, 232, 240); doc.rect(60, cy, 100, 8, 'F');
            doc.setFillColor(...colAccent);
            doc.rect(60, cy, (hyperactiveRaw / 36) * 100, 8, 'F');

            drawFooter(2);

            // PÁGINA 3
            doc.addPage(); drawHeader(3);
            cy = 50;
            doc.setFont("helvetica", "bold"); doc.setFontSize(16); doc.setTextColor(...colPrimary);
            doc.text("2. INTERPRETAÇÃO CLÍNICA", margin, cy);
            cy += 10;
            doc.setFont("helvetica", "normal"); doc.setFontSize(11); doc.setTextColor(50);

            let txt = "";
            if (isPositive) {
                txt = "Seus resultados apontam para um perfil neurodivergente compatível com TDAH. Isso sugere que suas dificuldades não são fruto de 'falta de vontade', mas de uma disfunção executiva no lobo frontal.\n\n" +
                "O Cérebro TDAH busca dopamina constantemente. Isso explica a dificuldade em iniciar tarefas chatas (procrastinação) e a facilidade em focar no que é estimulante (hiperfoco).";
            } else {
                txt = "Seus resultados atuais não preenchem os critérios completos para TDAH. É importante considerar que sintomas de desatenção podem ser causados por: Ansiedade Generalizada, Burnout, Uso excessivo de telas ou Privação de sono.";
            }
            let lines = doc.splitTextToSize(txt, pageWidth - (margin*2));
            doc.text(lines, margin, cy + 5);

            if (isPositive) {
                let by = cy + (lines.length * 6) + 15;
                doc.setFillColor(239, 246, 255); doc.setDrawColor(37, 99, 235);
                doc.rect(margin, by, pageWidth - (margin*2), 35, 'FD');
                doc.setFont("helvetica", "bold"); doc.setTextColor(...colAccent);
                doc.text("INVESTIGAÇÃO DE COMORBIDADES", margin + 5, by + 8);
                doc.setFont("helvetica", "normal"); doc.setTextColor(0); doc.setFontSize(10);
                let cross = "Atenção: 40% a 60% dos adultos com TDAH também apresentam traços de Autismo (TEA) ou Ansiedade Crônica. Recomendamos realizar os testes de TEA e GAD-7 disponíveis no dashboard.";
                doc.text(doc.splitTextToSize(cross, pageWidth - (margin*2) - 10), margin + 5, by + 16);
            }
            drawFooter(3);

            // PÁGINA 4
            doc.addPage(); drawHeader(4);
            cy = 50;
            doc.setFont("helvetica", "bold"); doc.setFontSize(16); doc.setTextColor(...colPrimary);
            doc.text("3. ESTRATÉGIAS", margin, cy);
            cy += 15;
            doc.setFont("helvetica", "normal"); doc.setFontSize(11); doc.setTextColor(50);
            let strat = "1. Externalize a Memória: Não confie no seu cérebro. Use agendas e quadros visuais.\n" +
            "2. Técnica dos Blocos: Trabalhe em tiros curtos de 25 minutos (Pomodoro).\n" +
            "3. Redução de Ruído: Tente usar 'Brown Noise' (Ruído Marrom) com fones.";
            doc.text(strat, margin, cy);

            cy += 50;
            doc.setDrawColor(22, 163, 74); doc.setLineWidth(1);
            doc.rect(margin, cy, pageWidth-(margin*2), 50);
            doc.setFillColor(22, 163, 74); doc.circle(margin+15, cy+25, 8, 'F');
            doc.setTextColor(255); doc.setFontSize(14); doc.text("!", margin+14, cy+28);
            
            doc.setTextColor(22, 163, 74); doc.setFont("helvetica", "bold"); 
            doc.text("LEITURA OBRIGATÓRIA", margin+30, cy+15);
            doc.setTextColor(0); doc.setFont("helvetica", "normal"); doc.setFontSize(11);
            doc.text("A ansiedade é o maior inimigo do TDAH. Entenda como tratá-la:", margin+30, cy+25);
            doc.setFont("helvetica", "bold");
            doc.text("'Tratamento da Ansiedade - Da estabilização à Integração'", margin+30, cy+35);
            doc.setFont("helvetica", "normal");
            doc.text("Autor: Eduardo Pokk", margin+30, cy+42);

            drawFooter(4);
            doc.save(`Dossie_TDAH_${currentUser.name.replace(/\s/g, '_')}.pdf`);
        }
    </script>
</body>
</html>